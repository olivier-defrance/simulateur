<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulateur IntradayGraf 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }

    :root {
      --bg1:#e0f2fe;
      --bg2:#f8fafc;
      --card:#ffffffee;
      --border:#e2e8f0;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#3b82f6;
      --primary-dark:#2563eb;
    }

    body.dark {
      --bg1:#0f172a;
      --bg2:#020617;
      --card:#0f172acc;
      --border:#1f2937;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --primary:#38bdf8;
      --primary-dark:#0284c7;
    }

    body {
      margin:0;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:linear-gradient(to bottom,var(--bg1),var(--bg2));
      color:var(--text);
      padding:18px;
      transition: background .25s ease, color .25s ease;
    }

    .app { max-width:900px; margin:auto; }

    header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:22px;
    }

    h1 { margin:0 0 6px; font-size:1.8rem; }

    .subtitle {
      color:var(--muted);
      font-size:.9rem;
      line-height:1.3;
    }

    .theme-toggle {
      cursor:pointer;
      padding:6px 12px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:999px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .card {
      background:var(--card);
      padding:18px;
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      margin-bottom:22px;
    }

    .card h2 {
      margin:0 0 12px;
      font-size:1.2rem;
      display:flex;
      align-items:center;
      gap:8px;
    }

    label { font-size:.9rem; color:var(--muted); display:block; margin-bottom:4px; }

    input, select {
      width:100%; padding:9px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:1rem;
      background:white;
    }

    input:focus,select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(59,130,246,0.3);
    }

    .btn {
      margin-top:16px;
      width:100%; padding:10px;
      background:var(--primary);
      color:white; border:none;
      font-size:1rem; font-weight:600;
      border-radius:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .btn:hover { background:var(--primary-dark); }

    .error {
      color:#dc2626;
      font-size:.85rem;
      margin-top:6px;
    }

    /* --- GRID R√âSULTATS --- */

    .result-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:14px;
      margin-top:14px;
    }

    .result-section-label {
      grid-column: 1 / -1;
      margin-top:6px;
      color:var(--muted);
      font-size:.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .stat {
      background:white;
      border-radius:10px;
      padding:12px;
      border:1px solid var(--border);
    }

    body.dark .stat {
      background:#020617;
    }

    .stat-label { font-size:.8rem; color:var(--muted); }
    .stat-value { font-size:1.2rem; margin-top:3px; }

    @media(max-width:600px){
      body { padding:12px; }
      .result-grid { grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <div>
      <h1>Simulateur IntradayGraf 2026</h1>
      <div class="subtitle">
        R√©sultats sur base de l'historique du robot sur l'actif ¬´ Allemagne 40 Cash (15mn) ¬ª<br>
        sur la p√©riode du 01/01/2017 au 10/11/2025
      </div>
    </div>
    <button id="themeToggle" class="theme-toggle">
      <span id="themeIcon">üåû</span>
      <span id="themeLabel">Mode clair</span>
    </button>
  </header>

  <!-- Param√©trage -->
  <div class="card">
    <h2>‚öôÔ∏è Param√®tres</h2>

    <label>Capital allou√© (‚Ç¨)</label>
    <select id="capital">
      <option value="">Chargement‚Ä¶</option>
    </select>

    <label style="margin-top:10px;">Drawdown max accept√© (‚Ç¨)</label>
    <input id="ddMax" type="number" min="0" step="100" value="1500">

    <label style="margin-top:10px;">Objectif</label>
    <select id="objectif">
      <option value="serenite">üßò‚Äç‚ôÇÔ∏è S√©r√©nit√© (Sharpe)</option>
      <option value="performance">‚ö° Performance (Gain)</option>
    </select>

    <button id="runBtn" class="btn">
      <span>üöÄ</span>
      <span>Lancer la simulation</span>
    </button>
    <div id="formError" class="error" style="display:none;"></div>
  </div>

  <!-- R√©sultats -->
  <div class="card" id="resultCard" style="display:none;">
    <h2>üìä Param√©trage optimal constat√©</h2>
    <div style="color:var(--muted); font-size:.85rem;" id="contextText"></div>

    <div class="result-grid">

      <!-- SECTION 1 : Param√®tres robot -->
      <div class="result-section-label">
        üß© Param√®tres √† appliquer dans le robot IntradayGraf 2026 :
      </div>

      <div class="stat">
        <div class="stat-label">Instrument</div>
        <div id="instrument" class="stat-value">‚Äì</div>
      </div>

      <div class="stat">
        <div class="stat-label">Risque par trade</div>
        <div id="risk" class="stat-value">‚Äì</div>
      </div>

      <!-- SECTION 2 : Performance -->
      <div class="result-section-label" style="margin-top:10px;">
        üìà Performance :
      </div>

      <div class="stat">
        <div class="stat-label">Gain total</div>
        <div id="gain" class="stat-value">‚Äì</div>
      </div>

      <div class="stat">
        <div class="stat-label">Drawdown max</div>
        <div id="dd" class="stat-value">‚Äì</div>
      </div>

      <div class="stat">
        <div class="stat-label">Gain total / Drawdown max</div>
        <div id="sharpe" class="stat-value">‚Äì</div>
      </div>

      <div class="stat">
        <div class="stat-label">% trades gagnants</div>
        <div id="win" class="stat-value">‚Äì</div>
      </div>

      <div class="stat">
        <div class="stat-label">Nombre de trades</div>
        <div id="trades" class="stat-value">‚Äì</div>
      </div>

    </div>
  </div>

</div>

<script>
const URL = "https://supabase.olivdef.fr";
const KEY = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc2MzIxNzYwMCwiZXhwIjo0OTE4ODkxMjAwLCJyb2xlIjoiYW5vbiJ9.UagouIBtD8p_dKm3pJX1J2wgaiDfq0vkNo6Cv6FdCbY";
const TABLE = "DataIntradayGrafV4-3";

/* Pourcentage gagnant = x100, 2 d√©cimales */
function pct(v){ return v==null ? "‚Äì" : (v*100).toFixed(2)+" %"; }
function money(v){ return v==null ? "‚Äì" : new Intl.NumberFormat("fr-FR").format(v)+" ‚Ç¨"; }

/* -------- CAPITAUX -------- */
async function loadCapital() {
  try {
    const r = await fetch(`${URL}/rest/v1/${TABLE}?select=Capital`, {
      headers:{apikey:KEY, Authorization:"Bearer "+KEY}
    });
    if (!r.ok) throw new Error("HTTP "+r.status);
    const rows = await r.json();
    const caps = [...new Set(rows.map(r=>r.Capital))].sort((a,b)=>a-b);
    const select = document.getElementById("capital");
    select.innerHTML = "<option value=''>Choisir‚Ä¶</option>";
    caps.forEach(c=>{
      const o=document.createElement("option");
      o.value=c; o.textContent=c+" ‚Ç¨";
      select.appendChild(o);
    });
  } catch(e) {
    console.error(e);
    const select = document.getElementById("capital");
    select.innerHTML = "<option value=''>Erreur de chargement</option>";
  }
}

/* -------- SIMULATION -------- */
async function runSim() {
  const capitalSelect = document.getElementById("capital");
  const ddMaxInput = document.getElementById("ddMax");
  const objectifEl = document.getElementById("objectif");
  const formError = document.getElementById("formError");
  const resultCard = document.getElementById("resultCard");

  const cap = Number(capitalSelect.value);
  const ddMax = Number(ddMaxInput.value);
  const objectif = objectifEl.value;

  if(!cap || !ddMax){
    formError.textContent = "Veuillez remplir le capital et le drawdown max.";
    formError.style.display = "block";
    resultCard.style.display = "none";
    return;
  }

  formError.style.display = "none";

  const path = `/rest/v1/${TABLE}?select=*&Capital=eq.${cap}&Drawdown=lte.${ddMax}`;

  try {
    const r = await fetch(URL+path,{
      headers:{apikey:KEY, Authorization:"Bearer "+KEY}
    });
    if (!r.ok) throw new Error("HTTP "+r.status);
    const rows = await r.json();

    if(!rows.length){
      resultCard.style.display="none";
      formError.textContent="Aucun r√©sultat pour cette configuration.";
      formError.style.display="block";
      return;
    }

    let best = rows[0];

    if(objectif==="serenite"){
      rows.forEach(r=>{ if((r.Sharpe ?? -Infinity) > (best.Sharpe ?? -Infinity)) best=r; });
    } else {
      rows.forEach(r=>{ if((r.Gain ?? -Infinity) > (best.Gain ?? -Infinity)) best=r; });
    }

    document.getElementById("contextText").textContent =
      `Capital ${cap} ‚Ç¨ ‚Ä¢ Drawdown max accept√© ${ddMax} ‚Ç¨`;

    document.getElementById("instrument").textContent = best.Actif ?? "‚Äì";
    document.getElementById("gain").textContent = money(best.Gain);
    document.getElementById("dd").textContent = money(best.Drawdown);
    document.getElementById("sharpe").textContent = best.Sharpe!=null ? best.Sharpe.toFixed(2) : "‚Äì";
    document.getElementById("win").textContent = pct(best.pGagnant);
    document.getElementById("trades").textContent = best.NbTrade ?? "‚Äì";
    document.getElementById("risk").textContent = best.pRisque!=null ? best.pRisque.toFixed(2) : "‚Äì";

    resultCard.style.display="block";

  } catch(e) {
    console.error(e);
    formError.textContent = "Erreur Supabase : " + e.message;
    formError.style.display = "block";
    resultCard.style.display = "none";
  }
}

/* -------- MODE SOMBRE -------- */
const themeToggle = document.getElementById("themeToggle");
const themeIcon = document.getElementById("themeIcon");
const themeLabel = document.getElementById("themeLabel");

themeToggle.onclick = ()=>{
  document.body.classList.toggle("dark");
  const dark = document.body.classList.contains("dark");
  themeIcon.textContent = dark ? "üåô" : "üåû";
  themeLabel.textContent = dark ? "Mode sombre" : "Mode clair";
};

/* Bind */
const runBtn = document.getElementById("runBtn");
runBtn.onclick = runSim;

/* Init */
loadCapital();

</script>
</body>
</html>
