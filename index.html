<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulateur IntradayGraf 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }

    :root {
      --bg1:#e0f2fe;
      --bg2:#f8fafc;
      --card:#ffffffee;
      --border:#e2e8f0;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#3b82f6;
      --primary-dark:#2563eb;
    }

    body.dark {
      --bg1:#0f172a;
      --bg2:#020617;
      --card:#0f172acc;
      --border:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --primary:#38bdf8;
      --primary-dark:#0284c7;
    }

    body {
      margin:0;
      font-family:system-ui;
      background:linear-gradient(to bottom,var(--bg1),var(--bg2));
      color:var(--text);
      padding:18px;
    }

    .app { max-width:900px; margin:auto; }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:22px;
    }

    h1 { margin:0 0 6px; font-size:1.8rem; }

    .theme-toggle {
      cursor:pointer;
      padding:6px 12px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:999px;
      font-size:.85rem;
    }

    .card {
      background:var(--card);
      padding:18px;
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      margin-bottom:22px;
    }

    label { font-size:.9rem; color:var(--muted); display:block; margin-bottom:4px; }

    input, select {
      width:100%; padding:9px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:1rem;
      background:white;
    }

    input:focus,select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px var(--primary + "33");
    }

    .btn {
      margin-top:16px;
      width:100%; padding:10px;
      background:var(--primary);
      color:white; border:none;
      font-size:1rem; font-weight:600;
      border-radius:10px;
      cursor:pointer;
    }

    .btn:hover { background:var(--primary-dark); }

    /* --- GRID RÃ‰SULTATS MOBILE-FRIENDLY --- */

    .result-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:14px;
      margin-top:14px;
    }

    .result-section-label {
      grid-column: 1 / -1;
      margin-top:10px;
      color:var(--muted);
      font-size:.9rem;
      font-weight:600;
    }

    .stat {
      background:white;
      border-radius:10px;
      padding:12px;
      border:1px solid var(--border);
    }

    .stat-label { font-size:.8rem; color:var(--muted); }
    .stat-value { font-size:1.2rem; margin-top:3px; }

    @media(max-width:600px){
      .result-grid { grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <div>
      <h1>Simulateur IntradayGraf 2026</h1>
      <div style="color:var(--muted); font-size:.9rem;">
        RÃ©sultats sur base de l'historique du robot sur l'actif "Allemagne 40 Cash (15mn)"
        <br>du 01/01/2017 au 10/11/2025
      </div>
    </div>
    <button id="themeToggle" class="theme-toggle">ðŸŒž Mode clair</button>
  </header>

  <!-- ParamÃ©trage -->
  <div class="card">
    <h2>ParamÃ¨tres</h2>

    <label>Capital allouÃ© (â‚¬)</label>
    <select id="capital">
      <option value="">Chargementâ€¦</option>
    </select>

    <label style="margin-top:10px;">Drawdown max acceptÃ© (â‚¬)</label>
    <input id="ddMax" type="number" min="0" step="100" value="1500">

    <label style="margin-top:10px;">Objectif</label>
    <select id="objectif">
      <option value="serenite">SÃ©rÃ©nitÃ© (Sharpe)</option>
      <option value="performance">Performance (Gain)</option>
    </select>

    <button id="runBtn" class="btn">Lancer la simulation</button>
    <div id="formError" style="color:red; margin-top:6px; display:none;"></div>
  </div>

  <!-- RÃ©sultats -->
  <div class="card" id="resultCard" style="display:none;">
    <h2>ParamÃ©trage optimal constatÃ©</h2>
    <div style="color:var(--muted); font-size:.85rem;" id="contextText"></div>

    <div class="result-grid">

      <!-- SECTION 1 : ParamÃ¨tres robot -->
      <div class="result-section-label">
        ParamÃ¨tres Ã  appliquer dans le robot IntradayGraf 2026 :
      </div>

      <div class="stat">
        <div class="stat-label">Instrument</div>
        <div id="instrument" class="stat-value">â€“</div>
      </div>

      <div class="stat">
        <div class="stat-label">Risque par trade</div>
        <div id="risk" class="stat-value">â€“</div>
      </div>

      <!-- SECTION 2 : Performance -->
      <div class="result-section-label">
        Performance :
      </div>

      <div class="stat">
        <div class="stat-label">Gain total</div>
        <div id="gain" class="stat-value">â€“</div>
      </div>

      <div class="stat">
        <div class="stat-label">Drawdown max</div>
        <div id="dd" class="stat-value">â€“</div>
      </div>

      <div class="stat">
        <div class="stat-label">Gain total / Drawdown max</div>
        <div id="sharpe" class="stat-value">â€“</div>
      </div>

      <div class="stat">
        <div class="stat-label">% trades gagnants</div>
        <div id="win" class="stat-value">â€“</div>
      </div>

      <div class="stat">
        <div class="stat-label">Nombre de trades</div>
        <div id="trades" class="stat-value">â€“</div>
      </div>

    </div>
  </div>

</div>

<script>
const URL = "https://supabase.olivdef.fr";
const KEY = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOi..."; /* remets ta clÃ© complÃ¨te */
const TABLE = "DataIntradayGrafV4-3";

/* Pourcentage gagnant = x100 */
function pct(v){ return v==null ? "â€“" : (v*100).toFixed(2)+" %"; }
function money(v){ return v==null ? "â€“" : new Intl.NumberFormat("fr-FR").format(v)+" â‚¬"; }

/* ---- Chargement des capitaux ---- */
async function loadCapital() {
  const r = await fetch(`${URL}/rest/v1/${TABLE}?select=Capital`, {
    headers:{apikey:KEY, Authorization:"Bearer "+KEY}
  });
  const rows = await r.json();
  const caps = [...new Set(rows.map(r=>r.Capital))].sort((a,b)=>a-b);
  const select = document.getElementById("capital");
  select.innerHTML = "<option value=''>Choisirâ€¦</option>";
  caps.forEach(c=>{
    const o=document.createElement("option");
    o.value=c; o.textContent=c+" â‚¬";
    select.appendChild(o);
  });
}

/* ---- Simulation ---- */
async function runSim() {

  const cap = Number(capital.value);
  const ddMax = Number(ddMaxInput.value);
  const objectif = objectifEl.value;

  if(!cap || !ddMax){
    formError.textContent="Veuillez remplir capital + drawdown max.";
    formError.style.display="block";
    return;
  }

  formError.style.display="none";

  const path = `/rest/v1/${TABLE}?select=*&Capital=eq.${cap}&Drawdown=lte.${ddMax}`;
  const r = await fetch(URL+path,{
    headers:{apikey:KEY, Authorization:"Bearer "+KEY}
  });
  const rows = await r.json();

  if(!rows.length){
    resultCard.style.display="none";
    formError.textContent="Aucun rÃ©sultat pour cette configuration.";
    formError.style.display="block";
    return;
  }

  let best = rows[0];

  if(objectif==="serenite"){
    rows.forEach(r=>{ if(r.Sharpe > best.Sharpe) best=r; });
  } else {
    rows.forEach(r=>{ if(r.Gain > best.Gain) best=r; });
  }

  contextText.textContent = `Capital ${cap} â‚¬ â€¢ DD max ${ddMax} â‚¬`;

  instrument.textContent = best.Actif;
  gain.textContent = money(best.Gain);
  dd.textContent = money(best.Drawdown);
  sharpe.textContent = best.Sharpe?.toFixed(2) ?? "â€“";
  win.textContent = pct(best.pGagnant);
  trades.textContent = best.NbTrade ?? "â€“";
  risk.textContent = best.pRisque?.toFixed(2);

  resultCard.style.display="block";
}

/* ---- Mode sombre ---- */
themeToggle.onclick = ()=>{
  document.body.classList.toggle("dark");
  themeToggle.textContent =
    document.body.classList.contains("dark")
    ? "ðŸŒ™ Mode sombre"
    : "ðŸŒž Mode clair";
};

/* Bind */
const capital = document.getElementById("capital");
const ddMaxInput = document.getElementById("ddMax");
const objectifEl = document.getElementById("objectif");

runBtn.onclick = runSim;

/* Init */
loadCapital();

</script>
</body>
</html>
